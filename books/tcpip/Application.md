# 应用协议

## 应用层协议概要

应用协议主要对应 OSI 分层中的会话层, 表示层和应用层的协议: 为了实现某种应用而设计和创造的协议.

## 远程登录

远程登录为了实现 TSS(Time Sharing System)环境, 是将主机和终端的关系应用到计算机网络上的一个结果. TSS 中通常有一个处理能力非常强的主机, 围绕着这台主机的是处理能力没有这么强的多个终端机器. 这些终端通过专线与主机相连. 远程登录主要使用 TELNET 和 SSH 两种协议.

### TELNET

TELNET 利用 TCP 的一条连接, 通过这条连接向主机发送文字命令并在主机上执行. 本地用户好像直接与远端主机内部的 Shell 相连着似的, 直接在本地进行操作. TELNET 可以分为两类基本服务: 仿真终端功能, 协商选项机制.

![show](https://image.cjyong.com/blog/tcpip/159.png)

#### 选项

TELNET 中除了处理用户所输入的文字外, 还提供选项的交互和协商功能. 如: 为了实现仿真终端(NVT, Network Virtual Terminal)所用到的界面控制信息就是通过选项功能发送出去的, 如上图所示 TELNET 中行模式或透明模式两种模式设置, 也是通过 TELNET 客户端与 TELNET 服务端之间的选项功能进行设置的.

![show](https://image.cjyong.com/blog/tcpip/160.png)

### SSH

SSH 是加密的远程登录系统. TELNET 中登录时无需输入密码可以发送, 容易造成通信窃听和非法入侵的危险. 使用 SSH 后可以加密通信内容. 即时信息被窃听也无法破解所发送的密码,具体的命令和命令返回的结果是什么.

SSH 还包括很多方便的功能:

- 可以使用更强的认证机制.
- 可以转发文件.
- 可以使用端口转发功能.

端口转发是指特定端口号所收到的消息转发到特定的 IP 地址和端口号码的一种机制. 由于经过 SSH 连接的那部分内容被加密, 确保了信息安全, 提供了更加灵活的通信.

![show](https://image.cjyong.com/blog/tcpip/161.png)

## 文件传输

FTP 是在两个相连的计算机之间进行文件传输时使用的协议. FTP 是通过怎样的机制实现文件传输: 建立两条 TCP 连接, 一条用来进行控制, 另一条用于数据(文件)的传输.

用于控制的 TCP 连接主要在 FTP 的控制部分使用. 例如登录用户名和密码验证, 发送文件的名称, 发送方式的设置. 利用这个连接, 可以通过 ASCII 码字符串发送请求和接收应答. 在这个连接上无法发送数据, 数据使用另外一条 TCP 进行连接.

![show](https://image.cjyong.com/blog/tcpip/162.png)

### 通过 ASCII 码字符进行交互处理

FTP 中请求命令中使用着`RETR`等 ASCII 码字符串, 而针对这些命令应答则使用如`200`等 3 位数字的 ASCII 码字符串. TCP/IP 的应用协议中有很多使用这种 ASCII 码字符串协议. 在 ASCII 码字符串型协议来说换行具有重要意义. 很多情况下, 一行字符串表示一个命令或一个应答. 而空白则用来表示参数之间的分隔符. 即, 命令和应答的消息通过换行区分, 参数使用空格区分. 换行由`CR(ASCII码中的十进制13)`和`LF(ASCII码的十进制数为10`两个控制符号组成.

## 电子邮件

### 电子邮件的工作机制

提供电子邮件服务的协议叫做 SMTP(Simple Mail Transfer Protocol). SMTP 为了实现高效发送邮件内容, 在其传输层使用了 TCP 协议.

早期电子邮件是在发送端主机和接收端主机之间直接建立 TCP 连接进行邮件传输. 发送人编写优先以后, 其内容会保存在发送端主机的硬盘中. 然后与对端主机建立 TCP 连接, 将邮件发送到对端主机的硬盘. 当发送正常结束后, 再从本地硬盘中删除邮件. 而在发送过程一旦发生对端计算机因没有插电等原因没有收到邮件, 发送端将等待一定时间后发送.

这个机制存在一些问题, 如只有发送端和接收端同时出去插电且开机的状态时才能实现电子邮件的传输. 但是对于某些存在严重时差的用户, 基本上无法进行通信. 所以这种机制基本不在使用.

为了解决这种情况, 而引进了一种一直会连接电源的邮件服务器. 发送和接收端通过邮件服务器进行收发邮件. 接收端从邮件服务器接收邮件时使用 POP3(Post Office Protocol)协议.电子邮件的机制由 3 部分组成, 分别是邮件地址, 数据格式以及发送协议.

### 邮件地址

使用电子邮件时拥有的地址叫做邮件地址. 相当于通信地址和姓名. 互联网中电子邮件格式如下: 名称@通信地址. 如: master@tcpip.kusa.ac.jp 中的 master 为名称, tcpip.kusa.ac.jp 为地址.地址与域名的构造相同.

现在电子邮件的发送地址由 DNS 进行管理, DNS 中注册有邮件地址及其作为发送地址时对应的邮件服务器的域名. 这些映射信息称作 MX 记录. 例如, kusa.ac.jp 的 MX 记录中指定为 mailserver.kusa.ac.jp, 于是任何发给以 kusa.ac.jp 结尾的地址的邮件都将发送到 mailserver.kusa.ac.jp 服务器. 通过 MX 记录指定邮件服务器, 可以管理不同邮件与特定邮件服务器之间的映射关系.

### MIME

早期的邮件只能处理文本格式的邮件. 后来邮件所能发送的数据类型拓展到了 MIME, 可以发送静态图像, 动画, 声音, 程序等各种形式的数据. 鉴于 MIME 规定了应用消息的格式, 因此在 OSI 参考模型中相当于第 6 层表示层.

MIME 基本上由首部和正文两部分组成, 首部不能是空行, 因为一旦出现空行, 后面的部分将被视为正文. 如果 MIME 首部的`Content-Type`中指定`Multipart/Mixed`, 并以`boundary=xxx`中以 xxx 作为分隔符, 就可以将多个 MIME 消息组合成为一个 MIME 消息. 这就叫做 multipart, 即各个部分都由 MIME 首部和正文数据组成.

![show](https://image.cjyong.com/blog/tcpip/163.png)

![show](https://image.cjyong.com/blog/tcpip/164.png)

### SMTP

SMTP 是发送电子邮件的协议, 使用的是 TCP 的 25 端口, SMTP 建立一个 TCP 连接后, 在这个连接上进行控制和应答以及数据的发送. 客户端以文本的形式发送请求, 服务端返回一个 3 位数的应答. 其中每个指令和应答最后都必须追加换行指令(CR,LF).

![show](https://image.cjyong.com/blog/tcpip/165.png)

![show](https://image.cjyong.com/blog/tcpip/166.png)

随着电子邮件的使用, 那些漫天的广告邮件和包含钓鱼连接的垃圾邮件成为了日益严重的问题. 并且 SMTP 本身没有验证发送者的功能, 人们无法避免这类邮件到达自己的邮件服务器. 不过现在通过`POP before SMTP`或`SMTP Authentication`等功能进行认证, 以此防止冒充发送者的人越来越多.

### POP

SMTP 是发送邮件的协议, 相对的 POP 则是接收邮件的协议. 个人电脑不可能长时间处于开机状态. 只有用户在使用时才会开机. 在这种情况下, 人们希望一开机就可以接收到邮件, 然而 SMTP 没有这种的处理机制, 因此引入了 POP 协议. 客户端根据 POP 协议从 POP 服务器接收对方发来的邮件, 在这个过程中, 为了防止他人盗窃邮件, 还需要进行用户认证.

![show](https://image.cjyong.com/blog/tcpip/167.png)

### IMAP

IMAP 与 POP 类似也是接收电子邮件的协议. 在 POP 中邮件由客户端进行管理, 而在 IMAP 中邮件则由服务器进行管理. 通过 IMAP 可以不从服务器上下载所有的邮件也可以阅读. 由于 IMAP 是在服务端进行处理邮件, 所以它可以下载邮件中某一份附件(而不是全部下载, 这点 POP 无法做到). 并且 IMAP 可以在服务器端对邮件进行`已读/未读/分类`等操作, 并且可以保持同步, 使用起来非常方便.通过 IMAP 人们可以通过个人电脑,手机,笔记本等连接到 IMAP 服务器进行收发邮件, 提供了很多的便利.

## WWW

万维网(WWW, World Wide Web)是将互联网中的信息以超文本形式展现的系统.

### WWW 的基本概念

WWW 定义了 3 个重要的概念, 它们分别是访问信息的手段与位置(URI, Uniform Resource Identifier), 信息的表现形式(HTML, HyperText Markup Language)以及信息转发(HTTP, HyperText Transfer Protocol)等操作.

### URI

URI: Uniform Resource Identifier, 用于标识资源. 如

- `http://www.rfc-editor.org/rfc/rfc4395.txt`
- `http://www.ietf.org:80/index.html`
- `http://localhost:631`

默认的格式是: `http://主机名(:端口号,不输入默认为80)/路径(?访问内容#部分信息)`.

### HTML

HTML 是记述 Web 页的一种语言, 可以指定浏览器显示的文字, 文字大小和颜色. HTML 具有纯文本的功能, 在页面中不仅可以为文字或图像附加链接, 当用户点击链接时还能呈现链接所指示的内容.

### HTTP

当用户在浏览器的地址栏里输入所要访问的 Web 页的 URI 以后, HTTP 的处理就会开始. HTTP 默认使用 80 端口, 工作机制: 客户端与服务器的 80 端口建立一个 TCP 连接, 然后在这个 TCP 连接上进行请求和应答以及相关数据报文的发送.

![show](https://image.cjyong.com/blog/tcpip/168.png)

### JavaScript, CGI, Cookie

JavaScript: 嵌入在 HTML 中的编程语言, 作为客户端程序运行于多种类型的浏览器中.
CGI: Web 服务器调用外部程序时所使用的一种服务端应用的规范.
Cookie: 存储于客户端保存信息, Cookie 常被用于保存登录信息或购物中放入购物车的商品信息.

## 网络管理

最初的网络管理是通过人为的进行干涉, 随着规模的变大, 个人的力量往往无法完成. 在 TCP/IP 的网络管理中可以使用 SNMP(Simple Network Management Protocol)收集必要的信息, 这是一款基于 UDP/IP 的协议. 在 SNMP 中, 管理端叫做管理器(Manager, 网络监控终端), 被管理端叫做代理(路由器, 交换机等).

![show](https://image.cjyong.com/blog/tcpip/169.png)

在 SNMPv3 中将`消息处理`,`用户安全`,`访问控制`三部分分开考虑, 为每一部分选择各自必要的机制.

如在`消息处理`模块, 会进行以下 8 种操作: 查询请求, 上一次的下一个信息的查询请求(GetNextRequest-PDU), 应答, 设置请求, 批量查询请求(GetBulkRequest-PDU), 向其他管理器发送消息通知(InformRequest-PDU), 事件通知, 用管理系统定义的命令(Report-PDU)等操作.

![show](https://image.cjyong.com/blog/tcpip/170.png)

## 其他应用层协议

### 多媒体通信实现技术

由于 TCP 具有流控制,拥塞控制,重发机制等功能, 有时应用发出的数据没有办法迅速到达对端目标主机. 然而互联网电话和电视会议中, 非常注重系统的及时性, 因此, 在实时多媒体通信中采用 UDP.

然而, 只使用 UDP 还是不可以达到进行实时多媒体通信的目的. 为了对通信过程进行合理的管理, 需要进行额外的控制. 控制主要采用 H.323 与 SIP 协议, 另外还需要 RTP 协议(结合多媒体数据本身特性进行传输的一种协议)和压缩技术(网络上传输音频, 视频等大型多媒体数据时进行压缩)的支持.

综合上述众多技术要求才能够真正实现实时多媒体通信. 此外, 互联网电视电话会议对实时性的要求远远高于当前任何一个数据通信领域. 因此在搭建网络环境时有必要考虑 QoS, 线路容量和线路质量等方面的要求.

#### H.323

H.323 是由 ITU 开发用于 IP 网上传输音频, 视频的一种协议.主要定义了 4 个组件: 终端(用户终端), 网关(吸收用户数据压缩顺序的不一致性), 网闸(电话本管理, 呼叫管理)以及多点控制单元(允许多个终端同时使用).

![show](https://image.cjyong.com/blog/tcpip/171.png)

#### SIP

与 H.323 相对 TCP/IP 协议即是 SIP(Session Initiation Protocol)协议. 相对 H.323, SIP 构成较为简单, 被认为更加适用于互联网.

终端之间进行多媒体通信时, 需要具备事先解析对方地址, 呼出对方号码并对所要传输的媒体信息进行处理等功能. 此外, 还需要具备终端通话和数据转发的功能. 这些功能(呼叫控制和指令)都被统一于 SIP 协议中. 相当于 OSI 参考模型中的会话层.

通过终端之间收发消息, 可以令 SIP 进行呼叫控制并做一些多媒体通信中必要的准备.

![show](https://image.cjyong.com/blog/tcpip/172.png)

#### RTP

UDP 不是一种可靠性传输协议, 因此会有丢包和乱序等现象. 因此采用 UDP 实现实时的多媒体通信需要附加一个表示报文顺序的序列号字段, 还需要对报文发送时间进行管理. 这正是 RTP(Real-Time Protocol)的主要职责.

RTP 为每个报文附加时间戳和序列号. 接收报文的应用, 根据时间戳决定数据重构的时机. 序列号则按照递加的原则进行. RTCP(RTP Control Protocol)是辅助 RTP 的一种协议, 通过丢包率等线路质量管理, 对 RTP 的数据传送率进行控制.

![show](https://image.cjyong.com/blog/tcpip/173.png)

#### 数字压缩技术

通过有效的压缩可以大量减少音频和视频数据的大小. 在有限的网络资源中进行多媒体数据的传输, 压缩技术成为了一个必要的手段.

MPEG(Moving Picture Experts Group)是决定数字压缩规范 ISO/IEC 工作组. 在这里制定的规范叫做 MPEG. 在 MPEG 的众多规范当中, MPEG1 主要用于 VideoCD, MPEG2 主要用于 DVD 和数字电视播放领域, 此外还有 MPEG4 和 MPEG7 等规范(MP3 也是属于 MPEG 的规范).

ITU-T 的 H.323 所规定的 H.261, H.263 与 MPEG 共同协作的产生了 H.264. 除此之外, 微软公司还有自己的规范.

### P2P

一般的网络通信都是属于一个服务器对应多个客户端的 C/S 模式, 即 1 对 N 的通信形态. 而网络上终端或者主机直接 1 对 1 相互通信的情况叫做 P2P(Peer To Peer).

![show](https://image.cjyong.com/blog/tcpip/174.png)

### LDAP

LDAP(Lightweight Directory Access Protocol)是访问目录服务的一种协议. LDAP 用于访问这种目录服务, 这种目录服务的规范作为 X.500 于 1988 年由 ISO 制定, 而 LDAP 在 TCP/IP 上实现了 X.500 中的一部分功能.
