# 仅仅依靠 IP 无法完成通信

在实际通信的过程中, 仅凭 IP 是远远不够的, 还需要众多支持 IP 的相关技术才能实现最终的通信.

## DNS

我们平常访问网站时并不使用 IP 地址, 而是使用类似(www.baidu.com)的网址. 这主要是有了 DNS(Domain Name System)功能的支持. DNS 可以将这串自动转换为具体的 IP 地址.

### IP 地址不便记忆

在互联网的起源 ARPANET 中, 起初由互联网信息中心(SRI-NIC)整体管理一份 hosts 文件. 如果需要新增一台计算机接入到 ARPANET 网或者其他计算机需要进行 IP 地址变更, 就需要更新这个 hosts 文件, 并且其他计算机需要定期下载最新的 hosts 文件才能正常使用网络. 随着网络规模不断扩大,接入计算机的个数不断增加, 这种集中管理的方式可行性逐渐降低.

在这个背景下就产生了一个可以有效管理主机名和 IP 地址之间关系的系统, 那就是 DNS 系统. 在这个系统中主机的管理机构可以对数据进行变更和设定, 即维护一个用来表示组织内部主机名和 IP 地址之间对应关系的数据库. 当用户输入主机名(域名)时, DNS 会自动检索那个主持了主机名和 IP 地址的数据库, 并迅速定位对应的 IP 地址.

### 域名的构成

域名由几个英文字母用点号连接构成, 采用分层的结构构造. 从最右边向左边依次分层: 顶级域名(TLD: Top Level Domain)如 com/cn/org, 二级域名, 三级域名.

![show](https://image.cjyong.com/blog/tcpip/92.png)

### DNS 查询

进行 DNS 查询的主机或者软件叫做 DNS 解析器(Resolver). 用户使用的工作站和个人电脑就属于解析器. DNS 查询的机制如下:

![show](https://image.cjyong.com/blog/tcpip/93.png)

解析器为了获取 IP 地址向域名服务器进行查询处理, 接收到这个查询请求的域名服务器首先会在自己的数据库进行查找. 如果有该域名对应的 IP 地址就直接返回. 如果没有, 则向上一层根域名服务器进行查询处理. 解析器和域名服务器将了解的信息暂时保存在缓存中. 这样就可以减少每次查询的性能损耗.

### DNS 如同互联网中的分布式数据库

之前说到 DNS 负责通过主机名检索 IP 地址, 然而它所管理的信息不仅仅是这些主机名和 IP 地址之间的映射关系, 还要管理众多其他信息. 如前面说的主机名对应 IP 地址叫做 A 记录. 反之, 从 IP 地址检索主机名称叫做 PTR. 此外, 上层或下层域名服务器的映射叫做 NS 记录.

![show](https://image.cjyong.com/blog/tcpip/94.png)

## ARP

ARP 是一种解决地址问题的协议(Address Resolution Protocol). 以目标 IP 地址为线索, 定位下一个应该接收数据分包的网络设备对应的 MAC 地址.如果目标主机不在同一个链路上, 可以通过 ARP 查找下一跳的路由器的 MAC 地址.ARP 只适用于 IPV4, 不能用于 IPV6, IPv6 使用 ICMPv6 来替代 ARP 发送邻居探索消息.

### ARP 的工作机制

ARP 是如何知道 MAC 地址的呢? 通过 ARP 请求和 ARP 响应两种类型的包确定的 MAC 地址.

![show](https://image.cjyong.com/blog/tcpip/95.png)

主机 A 为了获得主机 B 的 MAC 地址, 首先通过广播发送一个 ARP 请求包, 这个包里包含了想要了解的 MAC 地址的主机 IP 地址. 由于广播的包可以被同一个链路上所有的主机和路由器进行解析. 如果 ARP 请求包中的目标 IP 地址与自己的 IP 地址一致, 那么这个节点就将自己的 MAC 地址塞入 ARP 响应包返回给主机 A.

通过 ARP 可以动态地进行地址解析, 因此, 在 TCP/IP 的网络构造和通信中, 无需事先知道 MAC 地址究竟是什么, 只要 IP 地址即可.

如果每发送一个 IP 数据包都需要进行一次 ARP 请求来确定 MAC 地址, 那么将会造成不必要的网络流量, 通常的做法是将获取的 MAC 地址缓存一段时间, 即把第一次通过 ARP 获取的 MAC 地址作为 IP 对 MAC 的映射关系记忆到一个 ARP 缓存表中, 下一次再向这个 IP 地址发送数据报时不需要重新发送 ARP 请求, 而是按照这个缓存表中的 MAC 地址进行数据报的发送.每次进行一次 ARP 就将对应的缓存内容清除. 另外这个 MAC 地址缓存具有一定的期限, 超过这个期限, 缓存的内容将作废.

### IP 地址和 MAC 地址缺一不可

在同一个数据链路层中, 也许 IP 地址和 MAC 地址有些多余, 但是如果在两个数据链路层中时, IP 地址和 MAC 地址却是缺一不可的.

![show](https://image.cjyong.com/blog/tcpip/96.png)

如果主机 A 想发送 IP 数据包给主机 B, 就必须经过路由器 C, 即使知道主机 B 的 MAC 地址, 由于路由器 C 的隔断, 还是无法直接发送给主机 B, 必须先发送给路由器 C 的 MAC 地址 C1.再发送到主机 B 的 MAC 地址.

另外, 如果我们不使用 IP 地址, 全部通过 MAC 地址连接所有的主机和节点, 那就会需要网桥来维护一个巨大的表格来存储对应的地址. 一旦信息超出了可以承受的极限, 那将会导致网桥无法正常工作.

### RARP

RARP(Reverse Address Resolution Protocol)将 ARO 反过来, 通过 MAC 地址定位 IP 地址的一个协议. 如将打印服务器等小型嵌入式设备接入到网络时就会遇到这种情况. 平常我们可以通过个人电脑设置 IP 地址, 或者通过 DHCP 自动分配获取 IP 地址. 然而对于嵌入式设备, 有时候没有任何输入接口让你去设置 IP 地址, 且没办法通过 DHCP 来动态获取 IP 地址. 在这种情况下, 就需要使用 RARP 服务器, 在这个服务器上注册设备的 MAC 地址和 IP 地址. 设备接入网络时, 会发送一条"我的 MAC 地址是**_, 请告诉我,我的 IP 地址是什么", RARP 服务器接收到这个信息, 将返回类似"MAC 地址为_**的设备, IP 地址为\*\*\*"信息给这个设备. 设备按照接收的 IP 地址设置自己的 IP 地址.

![show](https://image.cjyong.com/blog/tcpip/97.png)

### 代理 ARP

通常 ARP 会被路由器隔离, 但是采用代理 ARP(Proxy ARP)的路由器可以将 ARP 请求转发给相领的网段. 由此, 两个网段的节点之间可以像在同一个网段中一样进行通信.

在目前的 TCP/IP 网络中, 一般情况下用路由器连接多个网络时, 会在每个网段定义自己的子网, 从而进行路由控制.

## ICMP

### 辅助 IP 的 ICMP

在我们架构 IP 网络时需要注意两点: 确认网络是否正常工作, 以及遇到异常时进行问题诊断.

ICMP 的主要功能包括: 确认 IP 包是否成功送达目标地址, 通知在发送过程当中 IP 包被废弃的具体原因, 改善网络设置等等.有了这些功能, 就可以获得网络是否正常, 设备是否存在问题, 从而便于进行网络上的问题诊断.

如在 IP 通信中, 某个 IP 包因为某种原因未能达到目标地址, 那么这个具体原因将由 ICMP 负责通知.

![show](https://image.cjyong.com/blog/tcpip/98.png)

如主机 A 向主机 B 发送数据包, 但是由于某种原因未能发送成功, 这时候路由器 2 就会向主机 A 发送一个 ICMP 包, 说明发往主机 B 的包未能成功. 这种通知信息会使用 IP 进行发送. 因此, 从路由器 2 返回的 ICMP 包会按照往常的路由控制先经过路由器 1 再转发给主机 A, 收到该 ICMP 包的主机 A 分解 ICMP 首部和数据域以后得知具体发生问题的原因.

ICMP 的消息大致分为两类: 一类是通知出错原因的错误信息, 一类是用于诊断的查询信息. ICMP 的消息类型:

![show](https://image.cjyong.com/blog/tcpip/99.png)

### 主要的 ICMP 消息

#### ICMP 目标不可达信息(3)

IP 路由器无法将 IP 数据包发送给目标地址时, 会给发送端主机返回一个目标不可达(Destination Unreachable Message)的 ICMP 消息, 并在这个消息中显示不可达的具体原因:

![show](https://image.cjyong.com/blog/tcpip/100.png)

#### ICMP 重定向消息(5)

如果路由器发现发送端使用次优的路径发送数据, 那么它将会返回一个 ICMP 重定向(ICMP Redirect Messae)的消息给这个主机. 一般是在路由器持有更好的路由信息的情况下, 路由器会通过 ICMP 消息给发送端主机一个更合适的发送路由.

![show](https://image.cjyong.com/blog/tcpip/101.png)

不过, 大多数情况下这种重定向有时会导致问题, 往往不进行这种设置.

#### ICMP 超时信息(11)

IP 包中包含一个字段叫做 TTL(Time To Live, 生存周期), 该值随着每次经过一个路由器减少 1, 直到减到 0 该 IP 包会被丢弃. 此时 IP 路由器将会发送一个 ICMP 超时信息(ICMP Time Exceeded Message, 错误号 0)给发送端主机, 并通知该包已被丢弃.

![show](https://image.cjyong.com/blog/tcpip/102.png)

#### ICMP 回送消息(0/8)

用于进行通信的主机或路由器之间,判断所发送的数据包是否已经成功到达对端的一种消息. 可以对端主机发送回送请求信息(ICMP Echo Request Message, 类型 8), 也可以接收对端主机发送回来的回送应答消息(ICMP Echo Reply Message, 类型 0). 网络中常用的 ping 命令(Packet InterNetwork Groper, 判断主机是否可达的一种命令)就是使用这个原理实现的.

![show](https://image.cjyong.com/blog/tcpip/103.png)

### 其他 ICMP 消息

#### ICMP 原点抑制消息(4)

在使用低速广域线路的情况下, 连接 WAN 的路由器可能会遇到网络堵塞的问题. ICMP 原点抑制信息(ICMP Source Quench Message)就是为了缓和这种拥堵情况. 当路由器向低速线路发送数据时, 其发送队列的残存变为零而无法发送出去, 就可以向 IP 包源地址发送一个 ICMP 原点抑制信息, 收到这个消息的主机借此了解线路上某一处发生了拥堵, 从而打开 IP 包的传输间隔. 然而这种 ICMP 可能会引起不公平的网络通信, 一般不被使用.

#### ICMP 路由器探索消息(9,10)

主要用于发现与自己相连网络中的路由器. 当一台主机发出 ICMP 路由器请求(Router Solicitation, 10)时, 路由器则返回 ICMP 路由器公告消息(Router Advertisement, 类型 9)给主机.

#### ICMP 地址掩码消息(17,18)

主要用于主机或路由器想要了解子网掩码的情况, 可以向那些目标主机或路由器发送 ICMP 地址掩码请求信息(ICMP Address Mask Request,17), 然后通过接收 ICMP 地址掩码应答消息(ICMP Address Mask Reply, 18)获取子网掩码信息.

### ICMPv6

#### ICMPv6 的作用

IPv4 中 ICMP 仅仅作为一个辅助作用于支持 IPv4. 即, 在 IPv4 时期, 即使没有 ICMP 仍然可以实现 IP 通信. 然而, 在 IPv6 中, ICMP 的作用被扩大, 如果没有 ICMPv6, IPv6 将无法进行正常通信.

IPv6 中, IP 地址定位 MAC 地址协议从 ARP 转为 ICMP 的邻居探索消息(Neighbor Discovery). 这种邻居探索消息融合了 IPv4 的 ARP, ICMP 重定向以及 ICMP 路由器选择消息等功能于一体, 甚至还提供了自动设置 IP 地址的功能.

ICMPv6 中将 ICMP 大致分为两类: 一类是错误消息, 一类是信息消息. 类型 0-127 属于错误信息, 128-255 属于信息消息.

![show](https://image.cjyong.com/blog/tcpip/104.png)

![show](https://image.cjyong.com/blog/tcpip/105.png)

#### 邻居探索

ICMPv6 中从类型 133 到类型 137 的消息叫做邻居探索消息. 这种邻居探索消息对于 IPv6 通信起着非常重要的作用, 用于查询 IPv6 的地址与 MAC 地址的对应关系, 并由邻居宣告消息得知 MAC 地址. 邻居请求消息利用 IPv6 的多播地址实现传输.

另外对于 IPv6 中实现的即插即用的功能, 所以没有 DHCP 服务器的环境下也能实现 IP 地址的自动获取. 如果没有一个没有路由器的网络环境中, 就使用 MAC 地址作为本地单播地址. 如果在一个有路由器的环境中, 可以从路由器获得 IPv6 地址的前面部分, 后面部分则由 MAC 地址进行设置.

## DHCP

### DHCP 实现即插即用功能

如果逐一为每一台主机设置 IP 地址会非常繁琐, 特别是移动设备(如笔记本电脑), 就会变得非常不方便.

于是, 为了实现自动设置 IP 地址, 统一管理 IP 地址分配, 就产生了 DHCP(Dynamic Host Configuration Protocol)协议. 有了 DHCP, 计算机只需要连接到网络, 就可以进行 TCP/IP 通信, 即实现了即插即用的功能. 同时适用于 IPv4, 也适用于 IPv6.

![show](https://image.cjyong.com/blog/tcpip/106.png)

### DHCP 的工作机制

使用 DHCP 之前, 首先需要架设一台 DHCP 服务器, 然后将 DHCP 所要分配的 IP 地址设置到服务器上. 此外, 还需要将相应的子网掩码, 路由控制信息以及 DNS 服务器的地址等设置在服务器上.

![show](https://image.cjyong.com/blog/tcpip/107.png)

使用 DHCP 时, 如果 DHCP 服务器遇到了故障, 就会导致无法自动分配 IP 地址, 从而导致网段内所有的主机无法进行 TCP/IP 通信. 为了避免这种情况, 通常人们架设两台或以上的 DHCP 服务器. 但是这种情况下, 可能导致 IP 地址冲突的情况.

为了检查所要分配 IP 地址以及已经分配的 IP 地址是否可用, DHCP 服务器或 DHCP 客户端必须具备以下功能:

- DHCP 服务器: 在分配 IP 地址前发送 ICMP 回送请求包, 确认没有返回应答.
- DHCP 客户端: 针对从 DHCP 哪里获得的 IP 地址发送 ARP 请求包, 确认没有返回应答.

在获得 IP 地址之前做这种事先处理可能耗一点时间, 但是可以安全地进行 IP 地址分配.

### DHCP 中继代理

家庭网络大多只有一个以太网(无线 LAN)的网段, 与其连接的主机台数不会太多. 因此, 只要有一台 DHCP 服务器就足以应对 IP 地址分配的需求, 而大多数的情况下都由宽带路由器充当 DHCP 的角色.

相比之下, 如果在企业或学校等较大规模组织机构的网络环境中, 一般会有多个以太网(无线 LAN)网段. 若针对每个网段都设置 DHCP 服务器将会是个庞大的工程. 即使路由器可以分担 DHCP 的功能. 如果网络中有不下 100 个路由器, 就要为 100 个路由器设置它们各自分配 IP 地址的范围, 并对这些范围进行维护, 这将是一个及其耗时和难于管理的工作.

因此在这类网络环境中, 往往需要将 DHCP 统一管理, 具体方法可以使用 DHCP 中继代理实现. 有了 DHCP 中继代理, 对不同 IP 地址分配也可以由一个 DHCP 服务器进行统一管理和运维. 这种方法使得每个网段假设一个 DHCP 服务器取代, 只需要每个网段设置一个 DHCP 中继代理即可. 它可以设置 DHCP 服务器的 IP 地址, 从而可以在 DHCP 服务器上为每个网段注册 IP 地址的分配范围. DHCP 客户端向 DHCP 中继代理发送 DHCP 请求包, DHCP 中继代理在收到这个广播之后, 再以单播的形式发送给 DHCP 服务器. 服务器说到该包以后再向 DHCP 中继代理返回应答, 并由 DHCP 中继代理将此包发送给 DHCP 客户端.

![show](https://image.cjyong.com/blog/tcpip/108.png)

## NAT

### NAT 定义

NAT(Network Address Translator)是用于在本地网络使用私有地址, 在连接互联网时转而使用全局 IP 地址的技术. 除了转换 IP 地址外, 还出现了可以转换 TCP,UDP 端口号的 NAPT(Network Address Ports Translator)技术, 由此可以实现用一个全局 IP 地址与多个主机通信.

NAT 实际上是为了解决地址枯竭的 IPv4 而开发的技术, 不过 IPv6 中为了提高网络安全也在使用 NAT, 在 IPv4 和 IPv6 之间相互通信常常使用 NAT-PT.

### NAT 的工作机制

![show](https://image.cjyong.com/blog/tcpip/109.png)

通过 NAT 路由器, 对发出的包修改源地址为全局 IP 地址, 对接收的包修改接收地址为本地 IP 地址. 在 NAT 路由器内部, 有一张自动生成用来转换地址的表. 当私有网络内多台机器同时都要对外进行通信时, 仅仅转换 IP 地址, 可能有时候全局 IP 地址不够用, 这时候采用包换端口号一起转换(NAPT)的方式解决这个问题(IP 相同, 端口不同区别不同的私有网络内的主机):

![show](https://image.cjyong.com/blog/tcpip/110.png)

### NAT-PT(NAPT-PT)

现在大多数的互联网服务都是基于 IPv4 的, 如果新的服务(基于 IPv6 实现的)也需要在 IPv4 环境中使用, 那就需要一个转换: NAT-PT. 将 IPv6 的首部转换为 IPv4 的首部, 有了这种技术, 那些只有 IPv6 地址的主机也能与 IPv4 地址的其他主机进行通信.

![show](https://image.cjyong.com/blog/tcpip/111.png)

### NAT 的潜在问题

由于 NAT(NAPT)都依赖自己的转换表, 因此会有以下几点限制:

- 无法从 NAT 的外部向内部服务器建立连接.
- 转换表的生成与转换操作都会产生一定的开销.
- 通信过程中一旦 NAT 遇到异常需要重新启动时, 所有的 TCP 连接都需要进行重置.
- 即使备置两台 NAT 做容灾备份, TCP 连接还是会被断开.

### 解决方案

- 改用 IPv6, 在 IPv6 的环境下可用的 IP 地址范围有了极大的拓展, 以至于可用为公司或家庭当中所有的设备都配置一个全局 IP 地址. 在这种情况下, IP 地址富余, 也就没有必要使用 NAT. 但是 IPv6 的普及较慢, 前景不容乐观.
- 应用层面进行解决, NAT 内侧的主机先发送一个虚拟的网络包给 NAT 的外面, NAT 依据要求构造包发出, NAT 外侧通过读取这个虚拟包得以知道内侧的信息. 应用可以与 NAT 路由器进行通信生成 NAT 表, 并通过一定的方法将 NAT 路由器上附属的全局 IP 地址传给应用. 这种现象叫做 "NAT 穿越": NAT 外侧与内侧可以进行通信. 但是这也会给应用带来极大的复杂性, 更换网络环境容易出错等问题.

## IP 隧道

![show](https://image.cjyong.com/blog/tcpip/112.png)

如图, 在这种网络环境里: 网络 A 和 B 使用 IPv6, 而中间的网络 C 使用 IPv4, 网络 A 和网络 B 是没办法直接进行通信的. 为了让它们进行正常通信, 就必须采用 IP 隧道功能.

在 IP 隧道中将网络 A 发过来的 IPv6 包统和为一个数据, 再为这个数据追加一个 IPv4 的首部转发给网络 C. 这样数据包就可以在网络 C 中传递给网络 B. 这种在网络层的首部后面继续追加网络层首部的通信方法叫做"IP 隧道".

![show](https://image.cjyong.com/blog/tcpip/113.png)

构造一个既支持 IPv4 又支持 IPv6 的网络是一项非常庞大的工程. 在这个网络环境中, 路由器的量可能涨到平时的两倍, 所以也会给网络管理员增加不少的负担. 在骨干网上通常使用 IPv6 或 IPv4 进行传输, 在那些不支持的路由器就可以采用 IP 隧道的技术转发数据包, 而对应的 IP 地址可以在一旁统一管理. 这一定程度上减轻了管理员的部分工作, 骨干网上的设备也仅仅需要在一旁应对 IP 隧道即可, 也可以大量减少投资成本.

如图展示了一个利用 IP 隧道转发多播消息的例子. 由于现在路由器上没有多播包的路由控制信息, 多播消息也就无法穿越路由器发送信息, 如果在这类环境中, 使用 IP 隧道, 可以使用单播的形式发包, 也就可以向较远的链路转发多播消息.

![show](https://image.cjyong.com/blog/tcpip/114.png)

## 其他 IP 技术

### IP 多播相关技术

多播通信中, 确认接收端是否存在非常重要, 如果没有接收端,发送多播消息会造成网络流量的浪费. 而确定是否有接收端, 要通过 MLD(Multicast Listener Discovery)实现. 它是 IPv4 中 IGMP(Internet Group Mangement Protocol)和 IPv6 中 IGMPv6 的重要功能.

IGMP(MLD)主要的两大作用:

- 路由器表明想要接收多播消息(并通知接收多播的地址).
- 向交换集线器通知想要接收多播的地址.

首先, 路由器会根据第一个作用, 了解到想要接收多播的主机, 并将这个信息告知其他路由器, 准备接收多播信息. 而多播信息的发送路径则由 IPM-SM, PIM-DM, DVMRP, DOSPF 等多播路由协议决定.

第二个作用也被称作 IGMP(MLD)探听, 通常交换集线器只会习得单播地址. 而多播一般都是和广播一样不经过过滤直接全部拷贝到端口上. 这会导致网络负荷加重.

为了解决这个问题, 可以采用第二个作用 IGMP(MLD)探听, 支持 IGMP(MLD)探听的交换集线器可以过滤多播帧, 也能降低网络负荷.

![show](https://image.cjyong.com/blog/tcpip/115.png)

### IP 任播

IP 任播主要用于报警电话 110 和消防电话 119 系统. 当人们拨打 110 或 119 时, 其接收电话并不是只有一个, 而是可以拨打到一个区域管辖范围内的所有公安或消防部门. 省,市,县,乡等不同级别的区域都各自设置着 110 与 119 的急救电话, 数量非常庞大.

这种机制的实现就是 IP 任播: 提供同一服务的服务器配置同一个 IP 地址, 并于最近的服务器进行通信的一种方法. 适用于 IPv4 和 IPv6. 最有名的例子, 就是 DNS 根域名服务器, 出于历史原因对 IP 地址的分类限制为 13 种类型, 但是从负载均衡与灾备应对的角度来看, 全世界的根域名服务器不可能只设置 13 处, 为此使用 IP 任播可以让更多的 DNS 根域名服务器遍布世界的各个角落.

IP 任播机制也存在一个问题, 无法保证第一个包和第二个包以及后续的包都是发送给同一个主机(因为有很多主机提供同一服务), 对于 UDP 请求可能没有问题, 因为不需要应答. 而对于面向连接的 TCP 通信或者要求在 UDP 中通过连续多个包通信时就可能存在问题.

### 通信质量控制

#### 通信质量的定义

IP 协议的设计和开发初衷是作为一个`尽力服务`的协议, 是一款`没有通信服务质量保证`的协议. 在`尽力服务`型的通信中,如果遇到通信线路拥堵的情况, 可能导致通信性能下降. 类似于高速公路上堵车. 通信线路上的拥堵叫做收敛, 当网络发生收敛时, 路由器和集线器(交换集线器)的队列(Buffer)溢出, 会出现大量丢包的现象, 从而极端影响通信性能.

最近几年随着音频和视频服务对实时性的要求逐渐提高, 在使用 IP 通信过程中能够保证服务质量(QoS, Quality of Service)技术收到了前卫所有的追捧.

#### 控制通信质量的机制

控制通信质量的工作机制类似于高速公路上的 VIP 通道. 对于需要保证通信质量的包, 路由器会进行特殊处理, 并在力所能及的范围之内对其进行优先处理. 人们提出了 RSVP 技术, 主要包括了两个内容: 一个是提供点对点的详细优先控制(IntServ)另一个是提供相对粗粒度的优先控制(DiffServ).

- IntServ: 针对特定应用(源 IP 地址, 目标 IP 地址, 源端口, 目标端口以及协议号完全一致)之间的通信进行质量控制的一种机制. 这种通信并非一直进行, 而是在必要的时候进行. 不过 RSVP 的机制相对复杂, 在大规模的网络中实施和应用比较困难.

![show](https://image.cjyong.com/blog/tcpip/116.png)

- DiffServ: 针对特定网络进行粗粒度的通信质量控制. 如, 针对某个特定的供应商进行顾客排名, 从而进行数据包的优先处理. 进行 DiffServ 质量控制的网络叫做 DiffServ 域, 在 DiffServ 域中路由器会对所有进入该域 IP 包首部的 DSCP 字段进行替换. 对于期望被优先处理的包设置一个优先值.

![show](https://image.cjyong.com/blog/tcpip/117.png)

### 显式拥塞通知

当发生网络拥堵时, 发送主机应该减少数据包的发送量. 作为 IP 上层协议, TCP 虽然可以控制网络拥塞, 不过它是通过数据包的实际损坏情况来判断是否发生了拥塞. 这种方法并不能在数据包损坏之前减少数据包的发送量.

为了解决这个问题, 人们在 IP 层新增了一种使用显示拥塞通知的机制: ECN(Explicit Congestion Notification). ECN 为实现拥塞通知功能, 将 IP 首部的 TOS 字段置换为 ENC 字段, 并在 TCP 首部的保留位追加 CWR 标志和 ECE 标志.

因此, ECN 的机制概况起来就是在发送包的 IP 首部中记录路由器是否遇到堵塞, 并在返回宝的 TCP 首部中通知是否发生了堵塞. 拥塞检查是在网络层进行, 而拥塞通知则在传输层进行. 这两层协助实现了拥塞通知的功能.

![show](https://image.cjyong.com/blog/tcpip/118.png)

### Mobile IP

#### Mobile IP 的定义

IP 地址由`网络地址`和`主机地址`两部分组成. 其中`网络地址`表示全网中子网的位置, 因此对于不同的地域它的值也会有所不同. 当移动设备移动时, 连接的子网一旦发生变化就无法通过 TCP 继续通信.TCP 是面向连接的协议, 从开始到结束都需要保证发送端和接收端主机 IP 地址不发生变化. UDP 的情况下也无法继续通信.

Mobile IP 登上历史舞台: 主机所连接的子网 IP 发生变化时, 主机 IP 地址保持不变, 应用也不需要做任何改动: 即使在 IP 地址发生变化的环境下, 通信也能继续.

其工作原理是:

![show](https://image.cjyong.com/blog/tcpip/119.png)

- 移动主机(MH: Mobile Host): 指那些移动了位置, IP 地址却不变的设备. 当前不变的 IP 地址称作移动地址(CoA: Care-of Address), 类似个人的户籍. 没有移动的时候, 所连接的网络叫做归属网络(类似户籍所在地).
- 归属代理(HA: Home Agent): 归属网络下, 可监控移动设备的位置, 并转发数据包给移动主机.
- 外部代理(FA: Foreighn Agent): 用于支持主机的移动设备.

#### Mobile IPv6

Mobile IP 中存在一些问题:

- 没有外部代理的网络无法通信.
- IP 包呈三角形路径转发. 转发效率不高.
- 为了提高安全, 可以检查 IP 地址用来核查是否是自己主机转发给自己的.

Mobile IPv6 中得到了解决:

- 外部代理由市县 Mobile IPv6 的移动主机自己承担.
- 考虑路径优化, 可以不用经过归属代理进行直接通信.
- IPv6 首部的源地址中赋予移动地址, 不让防火墙丢弃.

但是需要移动主机和通信对端的主机都需要支持 Mobile IPv6 才能使用以上功能.
