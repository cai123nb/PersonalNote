# 数据链路层

数据链路层指OSI参考模型中的数据链路层, 有时也指以太网.

## 数据链路的作用

TCP/IP中对于OSI参考模型的数据链路层及以下部分(物理层)未作定义. 因为TCP/IP以这两层的功能时透明的为前提. 然而, 数据链路的知识对于深入理解TCP/IP与网络起着非常重要的作用.

数据链路层的协议定义了通过通信媒介互连的设备之间传输的规范. 通信媒介包括双绞线电缆, 同轴电缆 光纤, 电波等介质.

计算机以二进制0,1来表示信息, 然而实际的通信媒介之间处理的却是电压的高低, 光的闪灭以及电波的强弱等信号. 把这些信号与二进制0,1进行转换是物理层的责任. 数据链路层处理的数据也不是单纯的0,1序列, 而是将它们集合为一个叫做"帧"的块, 然后进行传输.

`网络拓扑(Topology)`: 指的是网络的连接和构成的形态. 有: 总线型, 环型, 星型等等. 有时不仅仅是指配线上的机构, 更是指的是网络的组成结构.

![show](https://image.cjyong.com/blog/tcpip/29.png)

## 数据链路相关技术

### MAC地址

MAC地址用来识别数据链路中相连的节点. 以太网或FDDI中, 根据IEEE802.3规范使用MAC地址.

![show](https://image.cjyong.com/blog/tcpip/30.png)

MAC地址长48bit, 地址一般被烧入到ROM中. 因此, 任何一个网卡的MAC地址都是唯一的, 全世界都不会有重复的.

![show](https://image.cjyong.com/blog/tcpip/31.png)

> 全世界的MAC地址并不总是唯一的. 实际上, 即使MAC地址相同, 只要不是同属于一个数据链路就不会出现问题.

### 共享介质型网络

从通信介质(通信, 介质)的使用方法上看, 网络可以分为共享介质型和非共享介质型.

***共享介质型网络***: 指多个设备共享一个通信介质的一种网络. 最早的以太网和FDDI就是介质共享型网络. 在这种方式下, 设备之间使用同一个载波信道进行发送和接收. 基本上采用半双工通信的方式, 并有必要对介质进行访问控制. 主要采用两种介质访问控制方式: 争用方式和令牌传递方式.

#### 争用方式(Contention)

是指争夺获取数据传输的权力, 也叫CSMA(载波监听多路访问). 这种方法通常令网络中的各个站采用先到先得的方式占用信道发送数据. 如果多个站同时发送数据, 就会产生冲突, 导致网络拥堵和性能下降.

![show](https://image.cjyong.com/blog/tcpip/32.png)

##### CSMA/CD方式

部分以太网采用了改良CSMA方式: CSMA/CD方式.要求每个站提前检查冲突, 如果发生冲突, 则尽早释放信道.(1. 如果载波信道上没有数据流动, 则任何站都可以发送数据. 2. 检查是否会发生冲突, 一旦发生冲突时, 放弃发送数据, 同时立即释放载波信道. 3. 放弃发送以后, 随机延时一段时间, 在重新争用介质, 重新发送帧).

![show](https://image.cjyong.com/blog/tcpip/33.png)

#### 令牌传递方式

令牌传递方式是沿着令牌环发送一种叫做"令牌"的特殊报文, 是控制传输的一种方式. 只有获得令牌的站才能发送数据. 避免了冲突, 每个站都有通过平等循环获得令牌的机会, 网络拥堵也不会导致性能下降.

![show](https://image.cjyong.com/blog/tcpip/34.png)

### 非共享介质网络

非共享介质网络是不共享介质, 是对介质采取专用的一种传输控制方式. 在这种方式下, 每个网络中的每个站直连交换机, 由交换机负责转发数据帧. 这种方式下, 发送端与接收端不共享通信介质, 因此很多情况下采用全双工通信方式. 因此可以避免冲突, 达到更加高效的通信.(主流使用)

![show](https://image.cjyong.com/blog/tcpip/35.png)

> 半双工与全双工通信: 半双工是指, 只发送或只接收的通信方式, 类似广播, 无线电发送器. 全双工: 允许一方既可以发送数据也可以接收数据, 类似电话, 接打双方都可以同时说话.

### 根据MAC地址转发

在使用同轴电缆的以太网等介质共享网络中, 同一时间只能有一台主机发送数据. 当联网的主机数量增加时, 通信性能就会明显下降. 如果将集线器或集中器等设备以星型连接, 就出现了一款网络设备: 交换集线器, 亦称以太网交换机.

以太网交换机就是持有多个端口的网桥. 它们根据数据链路层中每个帧的目标MAC地址, 决定从哪个网络接口发送数据. 这是参考, 用来记录发送接口的表就叫做转发表(Forwarding Table).

这种转发表的内容不需要使用者在每个终端或交换机上手工设置, 而是可以自动生成. 这一过程也叫自学过程.

![show](https://image.cjyong.com/blog/tcpip/36.png)

由于MAC地址没有层次性关系, 当转发表中的入口个数与整个数据链路中所有网络设备的数量有关. 当设备数量增加时, 转发表也会变得很大, 检索转发表的时间也变得很长. 当连接多个终端时, 有必要分成多个数据链路, 采用类似网络层的IP地址一样对地址进行分层管理.

交换机一般两种转发方式, 存储转发: 检查以太网数据帧末尾FCS位后再进行转发. 因此可以避免发送由于冲突而被破坏的帧或者噪音导致的错误帧. 直通转发: 不需要全部接收帧, 只需要得知目标地址就可以进行转发, 延迟较短, 但是不能避免发送错误帧的可能性.

### 环路检测技术

如果使用网桥连接网络, 一旦出现环路又该如何处理(这与网络的拓扑结构和网桥种类有关)? 最坏情况下, 数据帧会在环路中被一而再再而三地持续转发. 一旦这样数据帧过多就会导致网络瘫痪.

一般的解决方式就是: 生成树和源路由两种方式. 如果网桥具备这两种的功能, 即使构建了环路的网络, 也不会造成严重的问题. 只要搭建合适的环路, 还能分散网络流量, 提高容灾能力.

#### 生成树方式

每个网桥必须在每1-10秒内相互交换BPDU(Bridge Protocol Data Unit)包, 从而判断哪些端口使用哪些不使用, 以便消除环路. 一旦发生故障, 则自动换通信线路, 利用没有使用的端口进行传输. IEEE802.1D中定义的生成树的方法有一个弊端, 就是网络故障切换网络时需要几十秒的时间. 为了解决这个问题IEEE802.1W中定义了一个RSTP(Rapid Spanning Tree Protocol)的方法, 将出现问题的恢复时间缩短到了几秒内.

#### 源路由法

最早由IBM提出, 以解决令牌环网络的问题, 该方式可以判断发送数据的源地址是通过那个网桥实现传输的, 并将帧写入RIF(Routing Infomation Field). 网桥根据这个RIF信息发送帧给目标地址. 因此, 即使出现了环路, 也不会被反复转发, 可以成功发送到目标地址. 但是要求发送端具备源路由的功能.

### VLAN

进行网络管理的时候, 时常会遇到分散网络负载, 变换网络设备的位置等情况. 有时, 不得不修改网络的拓扑结构, 这就意味着需要对硬件线路进行改造. 但是如果使用VLAN技术的网桥, 就不用实际修改网络布线, 只需要修改网络的结构即可. VLAN技术附加到网桥/2层交换机, 就可以切断所有的VLAN之间的通信. 因此VLAN可以过滤多余包, 提高网络的承载效率.

![show](https://image.cjyong.com/blog/tcpip/37.png)

可以对这种VLAN进行拓展, IEEE802.1Q的标准(TAG VLAN), 该标准允许包含跨越异构交换机的网段. 每个TAG VLAN对每个网段都使用一个VLAN ID标签进行唯一标识. 根据ID, 决定发送到那个网段.

![show](https://image.cjyong.com/blog/tcpip/38.png)

## 以太网

在大多数的数据链路中最为著名和广泛使用的就是以太网(Ethernet). 以太网最早是美国的Xerox公司与前DEC公司设计的一种通信方式, 当时命名为Ethernet. 之后由IEEE802.3委员会将其规范化.

### 以太网连接方式

以太网普及之初, 一般采用多台终端使用同一根同轴电缆的共享型连接方式. 初期的以太网结构举例:

![show](https://image.cjyong.com/blog/tcpip/39.png)

随着技术的发展, 现在一般都采用终端和交换机之间独占电缆的方式实现以太网通信.

![show](https://image.cjyong.com/blog/tcpip/40.png)

### 以太网的分类

以太网因为通信电缆的不同以及通信速度的差异, 衍生出众多不同的以太网类型. 如前面的: 100BASE-TX. 前面的数字100, 代表着传输速度100Mbps, 还有类似的10: 10Mbps, 1000: 1Gbps, 10G: 10Gbps. 而BASE后面的2,5,T,F,TX则是代表不同的传输介质. 如2,5: 同轴电缆; T:双绞线(UTP-CAT 3-5); F:多模绞线(MMF); TX: 双绞线(UTP-CAT5/STP); FX: 多模光纤(MMF)等等.

> 注意这里的计算方式和计算机有所不同, 计算机内部使用二进制, 2^10代表, 1K: 1024. 1M = 1024K. 1G = 1024M. 而以太网中以时钟频率决定传输速度. 1K = 1000; 1M = 1000K; 1G = 1000M.

### 以太网历史

最早规范化的以太网采用同轴总线型10BASE5网络. 后来, 随着传输技术的发展, 出现了细同轴电缆10BASE2, 双绞线10BASE-T, 100BASE-T(千兆以太网)以及10G以太网等众多以太网规范.

最初以太网的访问控制一般是以半双工通信为前提采用CSMA/CD方式. CSMA/CD前身与以太网同步使用, 主要用来解决冲突检查的问题. 但是这种方式也成为了以太网高速化的一个主要瓶颈, 即时出现了100Mbps的FDDI, 以太网仍然滞留在10Mbps的速度上, 人们一度放弃以太网.

后来随着ATM交换技术的进步和CAT5 UTP电缆的普及, 以太网的结构也发生了变化, 逐渐采用像共享介质网络那样直接与交换机连接的方式. 于是, 冲突检查不再是必要内容, 网络也变得更加高速.

> IEEE802: IEEE(The Institute of Electronical and Electronics Engineers, 美国电子和电气工程师协会)委员会, 依据不同的工作小组制定各种局域网技术标准. 由于在1980年2月启动局域网国际标准化项目, 所以命名为802.

### 以太网帧格式

以太网帧前端有一个叫做前导码(Preamble)的部分, 由1,0交替组合而成, 表示一个以太网帧的开始, 也是对端网卡可以确保与其同步的标准. 而前导码的末尾为SFD(Start Frame Delimiter)的域, 值为11, 表示帧本体数据开始.

![show](https://image.cjyong.com/blog/tcpip/41.png)

以太网帧本体前端是以太网的首部, 共占据14个字节(1字节8bit): 6个字节的目标MAC地址, 6个字节的源MAC地址以及2个字节的上层协议的类型.

![show](https://image.cjyong.com/blog/tcpip/42.png)

本体数据尾部是4字节的FCS(Frame Check Sequence, 帧检验序列)的4个字节, 用来校验数据是否出现损坏. 一个数据帧可以容纳的最大数据范围为: 46 - 1500个字节. 而IEE802.3 Ethernet与一般的以太网在帧的首部稍有区别, 添加了LLC和SNAP字段, 之前的类似变成了帧长度. 类型则是出现在SNAP字段中. 而带有VLAN标记的交换机之间流动的以太网帧格式又有较大的变化:

![show](https://image.cjyong.com/blog/tcpip/43.png)

数据帧对比图:

![show](https://image.cjyong.com/blog/tcpip/44.png)

## 无线通信

无线通信通常使用电磁波, 红外线, 激光等方式进行传播数据.

### 无线通信的种类

| 分类                               | 通信距离        | 标准化组织                  | 相关技术               |
|:---------------------------------|:------------|:-----------------------|:-------------------|
| 无线PAN(Personal Area Network)     | 10米左右       | IEEE802.15             | 蓝牙                 |
| 无线LAN(Local Area Network)        | 100米左右      | IEEE802.11             | Wi-Fi              |
| 无线MAN(Metropolitan Area Network) | 数千米-100千米   | IEEE802.16, IEEE802.20 | WiMAX              |
| 无线RAN(Regional Area Network)     | 200千米-700千米 | IEEE802.22             | -                  |
| 无线WAN(Wide Area Network)         | -           | GSM, CDMA200, W-CDMA   | 3G, LTE, 4G, 未来的5G |

### IEEE802.11

IEEE802.11定义了无线LAN协议中物理层与数据链路层的一部分(MAC层). IEEE802.11一般指的是众多标准的统称, IEEE802.11b/g/a/n等等, 也有时只是单纯指该标准. IEEE802.11是所有IEEE802.11相关标准的基础. 其中定义的数据链路层的一部分(MAC层)适用于所有的IEEE802.11其他标准. MAC层中的物理地址与以太网相同, 都使用MAC地址, 而介质访问控制上通过CSAM/CD相似的CSAM/CA(Carrier Sense Multiple Access with Sollision Avoidance)方式. 通常采用无线基站并通过高基站实现通信.

![show](https://image.cjyong.com/blog/tcpip/45.png)

基本连接方式:

![show](https://image.cjyong.com/blog/tcpip/46.png)

+ IEEE802.1b和IEEE802.11g: 是2.4Ghz频段中无线局域网标准. 它们最大传输速度达到了11Mbps和54Mbps, 通信距离达到了30-50米, 在介质访问控制层中使用CSMA/CA方式, 以基站作为中介进行通信.
+ IEEE802.11a: 物理层上使用5GHz频段, 最大速度达到54Mbps, 与IEEE802.11b/g存在一定兼容性问题.
+ IEEE802.11n: 在IEEE802.11g和IEEE802.11a的基础上, 添加了同步多条天线的MIMO(Multiple-Input Multiple-Output)技术, 实现高速无线通信的一种标准, 物理层使用2.4Ghz或5Ghz频段. 在使用5Ghz频段, 且不受其他频段的影响下, 最大速度甚至可以达到150Mbps.

## PPP

### PPP定义

PPP(Point-to-Point Protocol)是指点对点, 即1对1连接计算机的协议. PPP相当于OSI参考模型第2层的数据链路层.

PPP属于纯粹的数据链路层, 与物理层没有任何关系. 单纯使用PPP是无法进行通信的, 需要物理层的支持. PPP可以使用电话线或ISDN, 专线, ATM线路. 近些年来, 很多人们使用PPPoE(PPP over Ethernet)实现互联网接入.

### LCP与NCP

在进行数据传输前, 需要建立一个PPP级的连接. 当这个连接建立以后, 就可以进行身份认证, 压缩与加密.

在PPP的主要功能中包括两个协议: 一个是不依赖上层的LCP协议(Link Control Protocol), 另一个是依赖上层的NCP协议(Network Control Protocol). 如果上层为IP层, 此时NCP也叫做IPCP(IP Control Protocol).

LCP主要负责建立和断开连接, 设置最大接受单元(MRU, Maximum Receive Unit), 设置验证协议(PAP或CHAP)以及设置是否进行通信质量的监控.

IPCP则是负责IP地址设置以及是否进行TCP/IP首部压缩等设备.

![show](https://image.cjyong.com/blog/tcpip/47.png)

通过PPP连接时, 通常需要进行用户名密码的验证, 并且对通信两端进行双方向的验证. 其验证协议有两种, 分别为PAP(Password Authentication Protocol)和CHAP(Challenge Handshake Authentication Protocol).

+ PAP: 是在PPP连接建立的时候, 通过两次握手进行用户名和密码验证. 其中密码使用明文的方式进行传输. 因此一般用于安全要求并不是太高的环境, 否则有窃听和盗用连接的危险.
+ CHAP: 则是使用OTP(One Time Password), 可以有效防止窃听. 另外, 在建立连接后可以进行定期的密码交换, 用来校验对端是否中途被替换.

### PPP的帧格式

PPP本身是居于HDLC(High Level Data Link Control Procedure, 高级数据链路控制)制定出来的协议, HDLC在每个帧的前后添加8位字节"01111110", 用来区分帧. 这一个8位字节码叫做标记码. 在两个标记码之间不允许出现连续6个以上的"1"(防止和标准码冲突). 没出现连续5个1就必须插入一个0. 而接收端在接收帧的时候, 没接收连续5个1, 如果跟着0就必须进行删除.

![show](https://image.cjyong.com/blog/tcpip/48.png)

另外, 在电脑进行拨号的时候, PPP中这些插入或删除操作需要交给电脑进行处理, 会给电脑CPU带来一定的负荷.

### PPPoE

许多互联网接入服务商在以太网上利用PPPoE(PPP over Ethernet)提供PPP功能. 在这种互联网接入服务中, 通信线路通过以太网模拟, 但是单纯的以太网没有验证功能, 也没有建立和断开连接的处理, 因此无法按时计费. 然而处理PPPoE管理以太网, 就可以利用PPP的验证功能有效地管理终端用户的使用. 数据帧格式:

![show](https://image.cjyong.com/blog/tcpip/49.png)

## 其他数据链路

### ATM

ATM(Asynchronous Transfer Mode)是以一个叫做信元(5字节首部加48字节单位数据)的单位进行传输的数据链路层. 由于其线路占用时间短和可以高效传输大容量数据等特点主要用于广域网的连接. ITU和ATM论坛负责对ATM进行标准化.

#### ATM特点

ATM是面向连接的一种数据链路. 因此在进行通信传输之间一定需要设置通信线路. 但是并没有类似以太网和FDDI那种发送权限的限制. 它允许在任何时候发送任何数据. 因此大量计算机同时发送大量数据时容易引发网络拥堵甚至使网络进入收敛状态(网络非常拥堵, 无法处理包, 而对包进行丢弃). 为了防止这一现象的出现, ATM中增加了限制带宽的部分功能.

![show](https://image.cjyong.com/blog/tcpip/50.png)

> 同步: 以多个通信设备通过一条电缆相连的情况为例. 首先, 这样连接的设备叫做TDM(时分复用设备). TDM通常在两端TDM设备之间同步的同时, 按照特定的时间将每个帧分层若干个时限, (每个通信设备都占用一定比例的时间间隙, 即时没有数据, 也会发送空数据, 保证顺序), 线路的利用率较低.
> 异步: ATM拓展了TDM, 可以有效的提高线路的利用率. ATM并不是按照一定的顺序放入数据, 而是在数据的头部添加5字节的包首部, 包含VPI(Virtual Path Identifier), VCI(Virtual Channel Identifier)等识别码来标识具体的通信类型. 这样大大减少了空闲的时间间隙.

![show](https://image.cjyong.com/blog/tcpip/51.png)

#### ATM与上层协议

在以太网中一个帧最大可用传输1500个字节, FDDI可用最大传输4352字节, 而ATM一个信元却只能发送固定的58个字节数据. 这个48字节的数据部分如果包含IP首部和TCP首部, 则基本上无法存储上层数据. 因此一般不会单独使用ATM, 而是使用上层的AAL(ATM Adapter
Layer)(对于ATM是上层,对于IP是下层协议). 如果上层协议为IP协议, 则叫做AAL5. 每个IP包被附加各层的协议首部以后, 可以被分为最多192个信元发送出去.

![show](https://image.cjyong.com/blog/tcpip/52.png)

如图, 我们可以发现, 只要这192个信元中出现一个丢失或者损坏, 那么整个包就相当于被损坏了. 此时AAL5的帧检查为报错, 导致接受端不得不丢弃所有的信元. 因此只要丢失一个信元, 就需要重新发送最多192个信元. 这是ATM网中最大的弊端. 并且ATM没有办法进行发送权限控制, 很容易导致网络收敛. 在构建ATM网络的时候, 必须保证终端的带宽合计小于主干网的带宽, 还需要尽量保证信元不丢失.

![show](https://image.cjyong.com/blog/tcpip/53.png)

### POS

POS(Packet over SDH/SONET)是一种在SDH(Synchronous Digital Hierarchy, 同步数字体系)和SONET(Synchronous Optical Network, 同步光纤网络)上进行包传输的协议. SDH(SONET)是在光纤上传输数字信号的物理层规范. SDH作为利用电话线或专线等可靠性较高的方式进行光传输的网络, 正被广泛使用. 一般速率以51.84Mbps为基准, 一般为它的数倍.

### FDDI

FDDI(Fiber Distributed Data Interface)叫做分布式光线数据接口. 随着高速LAN(局域网)的发展, FDDI渐渐淡出人们的视线之外. FDDI采用令牌环的访问方式, 在网络拥堵的情况下极容易导致网络收敛.

![show](https://image.cjyong.com/blog/tcpip/54.png)

