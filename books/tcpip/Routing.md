# 路由协议

## 路由控制的定义

### IP地址与路由控制

互联网是由路由器连接的网络组合而成, 为了可以让数据包正确到达目标主机, 路由器必须在途中进行正确地转发. 而这种`正确的方向`转发数据所进行的处理就叫做路由控制或路由.

路由器根据路由控制表(Routing Table)转发数据包. 它根据所接收到的数据包中的目标主机的IP地址和路由控制表的比较得出下一个应该接收的路由器. 因此, 这个过程中路由控制表的记录一定要正确无误. 但凡出现问题, 数据包就可能无法到达目标主机.

### 静态路由与动态路由

路由控制分静态和动态两种. `静态路由`是指先设置好路由器和主机中并将路由信息固定的一种方法. 而`动态路由`是指路由协议在运行过程中自动设置路由控制信息的一种方法.

静态路由的设置通常是由使用者手工操作完成的. 如100个IP网时, 就需要设置近100个路由信息. 并且每增加一个新的网络, 就需要将这个新追加的网络信息设置在所有的路由器上. 因此, 静态路由给管理者带来很大的负担. 并且某一个路由器发生故障, 基本上无法自动绕过发生故障的节点, 只有管理员手工设置以后才能恢复正常.

动态路由的情况下, 管理员必须设置好路由协议, 设定过程复杂度与具体设置路由协议的类型有直接关系. 如在RIP的情况下, 基本上无需过多的设置. 而根据OSPF进行较详细路由控制时, 设置工作将会非常繁琐. 如果有新的网络添加到原有的网络中, 只要在新增加网络的路由器上进行一个动态路由的设置即可, 而不需要像静态路由一样, 在其他所有的路由器上进行设置, 在路由器个数较多的网络, 可以很大减轻管理员负担的方法. 并且一旦网络上发生故障, 只要有一个可绕的其他路径, 那么数据包就会自动选择这个路径.

![show](https://image.cjyong.com/blog/tcpip/137.png)

无论是静态路由还是动态路由, 不要只使用其中一种, 可以将它们组合起来使用.

## 路由控制范围

随着IP网络的发展, 想要对网络统一管理是不可能实现的事. 因此, 人们根据路由控制的范围经常使用IGP(Interior Gateway Protocol)和EGP(Exterior Gateway Protocol)两种类型的路由协议.

### 自治系统与路由协议

企业内部网络的管理方针, 往往由企业组织内部自行决定. 不一定每一个企业内部网络都是完全对外开放的, 而是进行一定的管理和屏蔽.

![show](https://image.cjyong.com/blog/tcpip/138.png)

自治系统内部动态路由采用的协议是域内路由协议, 即IGP. 而自治系统之间的路由控制采用的是域间路由协议, 即EGP.

### IGP与EGP

EGP: 外部网关协议, IGP: 内部网关协议. IP地址分为网络部分和主机部分, 它们有各自的分功, EGP与IGP的关系与IP地址网络部分和主机部分的关系有相似之处.  先进行EGP进行路由选择, 然后根据IGP在区域网络内部进行主机进行识别. IGP中还可以使用RIP(Routing Infromation Protocol, 路由信息协议), RIP2, OSPF(Open Shortest Path First, 开发式最短路径优先)等众多协议. 与之相对, EGP使用的是BGP(Border Gateway Protocol, 边界网关协议)协议.

## 路由算法

路由控制有各种各样的算法, 其中最具代表性的有两种: 距离向量算法(Distance-Vector)和链路状态算法(Link-State).

### 距离向量算法

距离向量算法(DV)是指根据距离(代价)和方向决定目标网络或目标主机位置的一种算法.

![show](https://image.cjyong.com/blog/tcpip/139.png)

路由器之间可以互换目标网络的方向及其距离相关的信息, 并以这些信息为基础制作路由控制表. 这种方法处理简单, 只有距离和方向信息, 但是网络构造时变得非常复杂, 在获得稳定的路由信息之前需要消耗一定时间, 也容易发生路由循环的问题.

### 链路状态算法

链路状态算法是路由器在了解网络整体连接状态的基础上生成路由控制的一种方法. 该方法中, 每个路由器都必须保持同样的信息才能做出正确的路由选择.

![show](https://image.cjyong.com/blog/tcpip/140.png)

在距离向量算法中存在一个缺点就是很难判断每个路由器上的信息是否正确, 而链路状态算法中, 所有的路由器都持有相同的信息, 对于任何一台路由器, 网络拓扑完全一样. 因此, 只要某一台路由器与其他路由器保持同样的路由控制信息即可. 但是为了实现该机制, 链路状态算法付出的代价就是如何从网络代理获取路由信息表. 这一过程非常复杂, 特别是在一个规模巨大且复杂的网络结构中, 管理和处理代理信息需要高速CPU处理能力和大量的内存.

### 主要的路由协议

路由协议分很多种,其中EGP协议不支持CIDR已经不再作为互联网的对外连接协议.

![show](https://image.cjyong.com/blog/tcpip/141.png)

## RIP

RIP(Routing Information Protocol)是距离向量型的一种路由协议, 广泛用于LAN. 被BSD UNIX作为标准而提供rounted采用了RIP, 而被广泛普及.

### 广播路由控制信息

RIP将路由控制信息定期(30秒一次)发往全网广播. 如果没有收到路由控制信息, 连接就会被断开. 但是为了防止丢包的情况, RIP规定等待5次, 如果等了6次(180秒)还没收到路由信息, 才会真正关闭连接.

![show](https://image.cjyong.com/blog/tcpip/143.png)

### 根据距离向量确定路由

RIP基于距离向量算法决定路径. 距离(Metrics)的单位为`跳数`(是指经过的路由器的个数).RIP希望尽可能少通过路由器将数据包发送到目标IP地址. 如图所示, 先根据距离向量生成距离向量表, 再抽出较小的路由生成最终的路由控制表.

![show](https://image.cjyong.com/blog/tcpip/144.png)

### 使用子网掩码时的RIP处理

RIP虽然不交换子网掩码信息, 但可与使用子网掩码的网络环境. 但是需要注意以下几点:
+ 从接口的IP地址对应分类得出网络地址后, 与根据路由控制信息流过此路由器的包中的IP地址对应的分类得出的网络地址进行比较. 如果两种网络地址相同, 那么就以接口的网络地址长度为准.
+ 如果两者的网络地址不同, 那么IP地址的分类所确定的网络地址长度为准.

如路由器的接口地址为192.168.1.33/27, 很显然, 这是一个C类地址, 因此根据IP地址分类它的网络地址为192.168.1.33/24.与192.168.1.33/24相符合的IP地址, 都应该将其网络地址视为27位.因此需要注意两点: IP地址分类而产生不同的网络地址; 构造网络地址长度不同的网络环境时.

![show](https://image.cjyong.com/blog/tcpip/145.png)

### RIP中路由变更时的处理

RIP的基本行为可以归纳为如下两点:
+ 将自己所知道的路由信息定期进行广播
+ 一旦认为网络被断开, 数据无法流过此路由器, 其他路由器就可以得知网络已经断开

![show](https://image.cjyong.com/blog/tcpip/142.png)

如图, 如果这时候网络A发生了故障, 路由器A虽然可以察觉到网络A的连接已经断开, 但是无法将网络A的信息发送给路由器B, 并且还会受到路由器B之前接收到的信息(路由器B距离网络A2Metrics). 这时路由器A就会误以为自己的信息还可以通过路由器B到达网络A.这种情况被称为无限计数(Counting to Infinity). 为了解决这样的问题, 一般采取以下两种方法:
+ 最长距离不超过16(距离为16的信息只会保留120秒, 系统默认无法到达, 而后将信息删除).
+ 规定路由器不再将收到的路由消息原路返还给发送端. 这被称作水平分割(Split Horizon).

![show](https://image.cjyong.com/blog/tcpip/146.png)

但是在环路的情况下, 还是存在信息回传的情况, 为了解决这个问题, 人们提出了`毒性逆转(Poisoned Reverse)`和`触发更新(Triggered Update)`两种方法. 毒性逆转是指当网络中发生链路断开的时候, 不是不再发送消息, 而是将这个无法通信的消息传播出去, 发送一个距离为16的消息. 触发更新是指当路由信息发生变化的时候, 不等待30秒而是立刻发送出去的一种方法. 有了这两种方法, 当链路不通的时候, 可以迅速发送消息让路由信息收敛.

![show](https://image.cjyong.com/blog/tcpip/147.png)

然而, 纵然使用了这些方法, 在一个具有众多环路的复杂环境中, 路由信息想要达到一个稳定的状态需要一段时间. 为了解决这个问题, 必须明确掌握网络结构, 因此可以使用OSPF.

### RIP2

RIP2的意思就是RIP的第二版, 在RIP的基础上进行了改良, 工作机制基本相同, 不过仍然有几个特点:
+ 使用多播: RIP中当路由器之间交换路由信息时采用广播的形式, 然而在RIP2中改用了多播, 不仅减少了网络流量, 还缩小了无关主机的影响.
+ 支持子网掩码: 类似OSPF, RIP2支持其交换的路由信息中加入子网掩码信息.
+ 路由选择域: 与OSPF的区域类似, 在同一个网络中可以使用逻辑上独立的多个RIP.
+ 外部路由标志: 通常用于把从BGP等获得的路由控制信息通过RIP传递给AS内.
+ 身份验证密钥: 与OSPF一样, RIP包中携带密码. 只有自己可以识别这个密码时才能接收数据, 否则忽略这个RIP包.

## OSPF

OSPF(Open Shortest Path First)是根据OSI的IS-IS协议提出的一种链路状态型路由协议. 由于采用链路状态类型, 所以即时网络中存在环路也可以实现稳定的路由控制.另外OSPF支持子网掩码,因此在RIP中无法实现的可变长度子网构造路由控制也成为了现实.OSPF还可以针对IP首部中的区分服务(TOS)字段生成多个路由控制表.

### OSPF是链路状态型路由协议

OSPF为链路状态型路由器, 路由器之间交换状态生成网络拓扑信息, 然后在根据这个拓扑信息生成路由控制表.

![show](https://image.cjyong.com/blog/tcpip/148.png)

RIP的路由选择, 要求途中所经过的路由器越少越好. 与之相比, OSPF可以给每条链路赋予一个权重, 并始终选择一个权重最小的路径作为最终路由. OSPF是以每个链路上的代价作为衡量标准, 始终选择一个总的代价最小的一条路径.

![show](https://image.cjyong.com/blog/tcpip/149.png)

### OSPF基础知识

在OSPF中, 把连接到同一个链路的路由器称作相邻路由器(Neighboring Router).在简单的网络结构中, 如每个路由器只跟一个路由器相连, 相邻路由器之间可以交换路由信息. 但是在一个较为复杂的网络中, 如在同一个链路中加入了以太网或FDDI等路由器, 就不需要在所有相邻的路由器之间都进行控制信息的交换, 而是确定一个指定路由器(Designated Router), 并作为中心交换路由信息即可.

在RIP中包的类型只有一种, 它利用路由控制信息, 一边确认是否连接网络, 一边传送网络信息. 但是这个设计有一个严重的问题: 当网络的个数越多, 每次需要交换的路由控制信息就越大. 并且当网络已经处于较为稳定的, 没什么变化的状态时, 还是需要定期更换相同的路由控制信息, 这在一定程度上浪费了网络带宽.

在OSPF中,根据作用的差别可以分为5种类型的包:
+ 问候(HELLO): 确认相邻路由器, 确定指定路由器.
+ 数据库描述(Database Description): 链路状态数据库的摘要信息.
+ 链路状态请求(Link State Request): 请求从数据库中获取链路状态信息.
+ 链路状态更新(Link State Update): 更新链路状态数据库中的链路状态信息.
+ 链路状态确认应答(Link State Acknowledgement): 链路状态信息更新的确认应答.

通过发送问候包确认是否连接, 每个路由器为了同步路由控制信息, 利用数据库描述(Database Description)包相互发送路由摘要信息和版本信息. 如果版本较老, 则首先发出一个链路状态请求(Link State Request)包请求路由控制信息, 然后由链路状态更新(Link-State Update)包接收路由状态信息, 最后再通过链路状态确认(Link State ACK Packet)包通知大家本地已经接收到了路由控制信息.

通过这个机制, OSPF不仅可以大大减少网络流量, 还可以达到迅速更新路由信息的目的.

### OSPF工作原理概述

OSPF中进行确认的协议叫做HELLO协议.

![show](https://image.cjyong.com/blog/tcpip/150.png)

LAN每10秒发送一个HELLO包, 如果没有HELLO包到达, 则进行连接师傅断开的判断, 允许空等3次, 直到第4次(40秒后)还没有任何反馈就认为是连接已经断开. 之后连接断开或恢复连接操作时, 由于链路状态发生了变化, 路由器会发送一个链路状态更新包(Link State Update Packet)通知其他路由器网络状态的变化. 链路状态更新包所要传达的信息大致分为两类:网络LSA, 路由器LSA.
+ 网络LSA: 以网络为中心生成的信息, 表示这个网络都与那些路由器相连接.
+ 路由器LSA: 以路由器为中心, 表示这个路由器都与那些网络相连接.

这两种信息都采用OSPF发送, 每个路由器都可以生成一个可以表示网络结构的链路状态数据库. 可以根据这个数据库, 采用Dijkstra算法(最短路径优先算法)生成相应的路由控制表.

相比距离向量, 由上述所生成的路由控制表更加清晰不容易混淆, 还可以有效降低无限循环问题的发生. 不过,当网络规模逐渐变大的时候, 最短路径优先算法的处理时间就会变得很长, 对CPU和内存的消耗也就越大.

### 对区域分层化进行细分处理

链路状态型路由协议潜在的问题就是: 当网络规模越来越大, 表示链路状态的拓扑数据库就变得越来越大, 路由控制信息的计算也就越困难. OSPF为了减少计算负荷, 引入了区域的概念.

区域是指将连接在一起的网络和主机划分成小组, 使一个自治系统(AS)内可以拥有多个区域. 不过具有多个自治系统必须要有一个主干区域(Backbone Area), 并且所有其他区域都要与这个主干区域相连.

连接区域与主干区域的路由器称作区域边界路由器, 而区域内部的路由器叫做内部路由器, 只与主干区域连接的路由器叫做主干路由器, 与外部相连接的路由器叫做AS边界路由器.

![show](https://image.cjyong.com/blog/tcpip/151.png)

每个区域内的路由器都持有本区域网络拓扑的数据库. 然而, 关于区域外的路径信息, 只能从区域边界路由器哪里获知它们的距离. 区域边界路由器也不会将区域内的所有链路状态信息发送给其他区域, 只会发送自己可以到达这些路由器的距离信息, 内部路由器所持有的网络拓扑数据库就会明显变小.

![show](https://image.cjyong.com/blog/tcpip/152.png)

作为区域出口的区域边界路由器如果只有一个的话, 叫做末端区域(如区域2). 末端区域的话不用发送区域外的路由信息, 它的区域边界路由器将作为默认的路径传送路由信息即可. 因此, 减少了一定的路由信息.

所以如果想在OSPF中构造一个稳定的网络, 物理设计和区域设计同样重要. 如果区域设计不合理, 就有可能无法发挥OSPF的优势.

## BGP

BGP(Border Gateway Protocol), 边界网关协议是连接不同组织机构(或者说连接不同自治系统)的一种协议. 因此, 它属于外部网关协议(EGP). 具体划分, 它主要是用于ISP之间相连接的部分.

### BGP与AS号

在RIP和OSPF中利用IP的网络地址部分进行路由控制, 然后BGP则需要放眼整个互联网进行路由控制. BGP的最终路由控制表由网络地址和下一站的路由器来表示, 不过它会根据所要经过的AS个数进行路由控制.

![show](https://image.cjyong.com/blog/tcpip/153.png)

ISP,区域网络等会将每个网络域编配成一个个自治系统(AS: Autonomous System)进行管理, 它们为每个自治系统分配了一个16比特的AS编号. BGP就是根据这个编号进行相应的路由控制.

有了AS编号的域, 就相当于有了自己一个独立的`国家`, AS的代表可以决定AS内部的网络运营和相关决策. 与其他AS相连的时候, 可以像`外交官`一样签署合约再进行连接(也叫做`对接(Peering)`). 正是有了这些不同地区的AS通过签约的相互连接, 才有了今天全球范围内的互联网. 如图, 为了使AS1与AS3之间可以进行通信, 需要有AS2或者AS4与AS5组合起来的两者中的一者进行数据中转才能实现. 而这两者是否愿意中转则是由自己决定. 如果不愿意的话, 那么AS1与AS3之间建立专线才能实现通信.

### BGP是路径向量协议

BGP是假设两者都允许中转, 根据BGP交换路由控制信息的路由器叫做BGP扬声器. BGP扬声器为了在AS之间交换BGP信息, 必须与所有的AS建立对等的BGP连接. 此外, 如图AS2,AS4,AS5, 它们在同一个AS内部有多个BGP扬声器. 在这种情况下, 为了使AS内部也可以交换BGP信息, 就需要建立BGP连接. BGP中数据包送达目标网络时, 会生成一个中途经过所有AS的编号列表. 这个表格也叫做AS路径信息访问列表(AS Path List). 如果针对同一个目标地址出现多条路径时, BGP会从AS路径信息访问列表中选择一个较短的路由. 在做路由选择使用的度量, RIP中表示为路由器的个数, OSPF中表示为每个子网的成本, 而BGP则用AS进行度量标准. RIP和OSPF本着提高转发效率为目的, 考虑到了网络的跳数和网络的带宽. BGP则基于AS之间的合约进行数据包的转发. BGP一般选择AS数最少的路径, 不过还要遵循各个AS之间签约的细节进行更细粒度的路由选择. 在AS路径信息访问列表中不仅包含转发方向和距离, 还涵盖了途径所有AS的编号. 因此它并不是一个距离向量型协议. 此外, 对网络构造只用一元化表示, 因此不属于链路状态型协议. 像BGP这种根据所要经过的路径信息访问列表进行路由控制的协议属于路径向量(Path Vector)型协议.作为路径向量型由于可以检测出环路, 避免了无限计数的问题, 令网络更加稳定, 并且它还有支持策略路由的优势.

![show](https://image.cjyong.com/blog/tcpip/154.png)

## MPLS

如今转发IP数据包的过程中除了使用路由技术外, 还在使用标记交换技术. 路由技术基于IP地址中最长匹配原则进行转发, 而标记交换则对每个IP包都设定一个`标记`的值, 然后根据这个`标记`进行转发. 标记交换技术中最具代表性当属多协议标记交换技术, 即MPLS(Multi Protocol Label Switching).

![show](https://image.cjyong.com/blog/tcpip/155.png)

MPLS的标记不像MAC地址直接对应到硬件, 因此MPLS不需要具备以太网或ATM等数据链路层协议的作用. 只需要关注它与下面一层IP层之间的功能和协议即可. 由于基于标记的转发通常无法在路由器上进行, 所以MPLS也就无法被整个互联网采用. 其转发方式也与IP网有所不同.

![show](https://image.cjyong.com/blog/tcpip/156.png)

### MPLS的网络基本动作

MPLS网络中实现MPLS功能的路由器叫做标记交换路由器(LSR, Lable Switching Router). 在LSR中与外部网络连接的那部分LSR叫做标记边缘路由器(LER, Lable Edge Router). MPLS正是在LER上对数据包进行追加标记和删除标记操作.

![show](https://image.cjyong.com/blog/tcpip/157.png)

MPLS中目标地址和数据包都要通过标记决定同一路径, 这个路径叫做标记交换路径(LSP, Label Switch Path). LSP又可以分为一对一连接的点对点LSP, 和一对多绑定的合并LSP两类. 扩展LSP有两种方式. 可以通过各个LSR想自己邻接的LSR分配MPLS标记, 也可以由路由协议载着标记信息进行交互. LSP属于单方向的通路, 如果需要双向的通信需要两个LSP.

![show](https://image.cjyong.com/blog/tcpip/158.png)

### MPLS的优点

MPLS的优点主要有两点:
+ 转发速度快: 路由器转发IP数据包时, 首先需要对目标地址和路由控制表中可变长的网络地址进行比较, 然后从中选出最长匹配的路径进行转发. MPLS则不然, 使用固定长度的标记信息, 处理简单, 可以通过高速硬件实现转发.并且MPLS需要设置的信息较少, 不用存储复杂的路由表.
+ 利用标记生成虚拟的路径, 并在它的上面实现IP等数据包的通信. 基于这些特点, 被称之为`尽力而为(Best-Effort)`的IP网可以提供基于MPLS的通信质量控制, 带宽保证和VPN等功能.
